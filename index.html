<!DOCTYPE HTML>
<!DOCTYPE html>
<html>
<head>
    <meta charset = "UTF-8"/>
    <title>Test</title>
    <script src = "js/phaser.js"></script>
    <script src = "js/Boot.js"></script>
    <script src = "js/Preload.js"></script>
    <script src = "js/Level1.js>"></script>
    <script src = "js/MainMenu.js"></script>
</head>


<body>
    <script type="text/javascript">
window.onload = function(){

    var game = new Phaser.Game(800,600,Phaser.CANVAS,'');

        game.state.add('Boot',Game.Boot);
        game.state.add('Preload',Game.Preload);
        game.state.add('MainMenu',Game.MainMenu);
        game.state.add('FailState',Game.FailState);
        game.state.add('Level1',Game.Level1);
        game.state.add('Level2',Game.Level2);

        game.state.start('Boot');

}


var Game = {};

Game.Boot = function(){};

//Loading the loading screen

Game.Boot.prototype = {

    init: function() {
        this.input.maxPointers = 1;

        this.stage.disableVisibilityChange = true;
    },

    //Assets we need for the loading screen
    preload: function() {
        this.load.image('preloader', 'assets/preload_bar.png');
    },

    create: function() {
        //Pass the torch to preload
        this.state.start('Preload');
    }
};

Game.Preload = function(){
    this.preloadBar = null;
};

Game.Preload.prototype = {
    preload: function() {

        //Preload bar rendering
        this.preloadBar = this.add.sprite(this.world.centerX, this.world.centerY + 25, 'preloader');
        this.preloadBar.anchor.setTo(0.5);
        this.time.advancedTiming = true;
        this.load.setPreloadSprite(this.preloadBar);

        //Asset loading
        this.load.tilemap('map', 'assets/maps/level1.csv');
        this.load.image('tileset', 'assets/tileset.png');
        this.load.image('player', 'assets/blackblock.png');
        this.load.spritesheet('buttons', 'assets/start_button.png', 193, 71);
        this.load.image('EnemyRed', 'assets/redblock.png');
        this.load.image('bullet', 'assets/bullet.png');
        this.load.audio('shoot','assets/shoot.wav');
        this.load.audio('thud','assets/thud.wav');
        this.load.audio('enemy_die','assets/enemy_die.wav');
    },

    create: function() {
        //Pass the torch to Level1
        this.game.state.start('MainMenu');
    }
};



//ACTUAL MENU BELOW



Game.MainMenu = function(){};

var button;

Game.MainMenu.prototype = {
    create: function() {

        startButton = this.add.button(this.world.centerX -95, this.world.centerY - 100, 'buttons', 
                                  function(){
                                    this.game.state.start('Level1');
                                  },this,2,1,0);

    }
}

//LEVEL 1 BELOW

//Defining enemy red
/*EnemyRed = function(index, game, x, y){

    this.red = game.add.sprite(x,y,'EnemyRed');
    this.red.anchor.setTo(0.5,0.5);
    this.red.name = index.toString();
    game.physics.enable(this.red,Phaser.Physics.ARCADE);
    this.red.body.immovable = true;
    this.red.body.collideWorldBounds = true;
    this.red.body.allowGravity = false;
*/


    //this.redTween = game.add.tween(this.red).to({
    //    y: 250,
    //}, 2000, 'Linear', true, 0, 250, true);

//}

var enemy1; 

Game.Level1 = function(){};

var map;
var layer;

var player;
var controls = {};
var playerSpeed = 325; 
var jumpTimer = 0;
var shootTime = 90;
var bullets;
var remaining = 10;
var chillTime = 200;
var chillTimeBad = 200;
var enemy1;
var enemy2;
var enemySpeed = 75;
var remainingText;

///var button;

Game.Level1.prototype = {

    create: function(game) {
        //Background color definition
        this.stage.backgroundColor = '#d3d3d3';

        //Map initialization
        map = this.add.tilemap('map', 25, 25)
        map.addTilesetImage('tileset');
        layer = map.createLayer(0);
        //layer.resizeWorld();
        remaining = 10;
        game.world.setBounds(0, 0, 1925, 1450);

        //Collision/Physics 
        this.physics.arcade.gravity.y = 1400;
        map.setCollisionBetween(0,0);
        //map.setTileIndexCallback(2,this.resetPlayer,this);

        //Set player
        player = this.add.sprite(150,275, 'player');
        player.anchor.setTo(0.5);
        //player.animations.add('runRight',[6, 7, 8, 9], 5, true);
        //player.animations.add('runLeft',[0, 1, 2, 3], 5, true);
        this.physics.arcade.enable(player);
        player.body.collideWorldBounds = true;
        game.physics.enable(player,Phaser.Physics.ARCADE);
        player.physicsBodyType = Phaser.Physics.ARCADE;
        player.body.velocity.x = 0;
        player.body.velocity.y = 0;

        //Set controls
        controls = {
            right: this.input.keyboard.addKey(Phaser.Keyboard.A),
            left: this.input.keyboard.addKey(Phaser.Keyboard.D),
            up: this.input.keyboard.addKey(Phaser.Keyboard.W),
            down: this.input.keyboard.addKey(Phaser.Keyboard.S),
            shoot: this.input.keyboard.addKey(Phaser.Keyboard.F),
        }
        cursors = game.input.keyboard.createCursorKeys();

        //button = this.add.button(this.world.centerX - 95, this.world.centerY + 200, 
        //                      'buttons', function(){
        //                          console.log("ay");
        //                      },this,2,1,0);

        
        //Init red enemies
        enemies = game.add.group();
        enemies.enableBody = true;
        enemies.setAll('anchor.x',0.5);
        enemies.setAll('anchor.y',0.5);
        enemies.setAll('allowGravity', false);
        enemy1 = enemies.create(550, 75, 'EnemyRed');
        enemy2 = enemies.create(100, 475, 'EnemyRed');
        enemy3 = enemies.create(150, 100, 'EnemyRed');
        enemy4 = enemies.create(862, 550, 'EnemyRed');
        enemy5 = enemies.create(1658, 247, 'EnemyRed');
        enemy6 = enemies.create(1808, 945, 'EnemyRed');
        enemy7 = enemies.create(1125, 1187, 'EnemyRed');
        enemy8 = enemies.create(841, 1308, 'EnemyRed');
        enemy9 = enemies.create(467, 1173, 'EnemyRed');
        enemy10 = enemies.create(259, 1320, 'EnemyRed');

        //Init bullets
        bullets = game.add.group();
        bullets.enableBody = true;
        bullets.physicsBodyType = Phaser.Physics.ARCADE;
        bullets.createMultiple(50, 'bullet');
        bullets.setAll('anchor.x',0.5);
        bullets.setAll('anchor.y',0.5);
        bullets.setAll('outOfBoundsKill', true);
        bullets.setAll('checkWorldBounds', true);
        bullets.setAll('allowGravity', false);

        //Heatlh bar of enemies
        this.barProgress = enemy1.hp;
        this.enemyBar1 = this.add.bitmapData(32,8);
        game.add.sprite(enemy1.x - (this.enemyBar1.width*0.5), enemy1.y - 25, this.enemyBar1);

        this.objectiveText = this.add.text(312, 100, 'Kill 10 enemies!', {fontSize: '32px', fill: '#000'});
        this.objectiveText.fixedToCamera = true;
        this.time.events.add(2000,function(){this.objectiveText.destroy();},this)

        remainingText = this.add.text(15, 15, 'Remaining: ' + remaining.toString(), {fontSize: '16px', fill: '#000'});
        remainingText.fixedToCamera = true;


    },


    update: function(game) {
        //Collision
        this.physics.arcade.collide(player,layer,function(){
            if(game.time.now > chillTime){
                game.add.audio('thud').play();
                chillTime = game.time.now + 200;
            }
        });
        this.physics.arcade.collide(enemies,layer);
        this.physics.arcade.collide(player,enemies, function(){
            game.camera.x = 0;
            game.camera.y = 0;
            game.state.start('FailState');
        });
        this.physics.arcade.collide(bullets,enemies, function(){   
            if(bullets.getFurthestFrom(player)!=null){
                bullet = bullets.getFurthestFrom(player);
            } else {
                bullet = bullets.getRandom()
            }
            game.add.audio('enemy_die').play();
            bullet.kill();
            enemies.getClosestTo(bullet).kill();
            remaining -= 1;
            remainingText.text = 'Remaining: ' + remaining.toString();
        });
        this.physics.arcade.collide(bullets,layer, function(){
            if(bullets.getFurthestFrom(player)!=null){
                bullets.getFurthestFrom(player).kill();
            } else {
                bullets.getRandom().kill();
            }
        });

        //Player movement
        player.body.velocity.x = 0.8*player.body.velocity.x;
        player.body.velocity.y = 0.8*player.body.velocity.y;
        if(Math.abs(player.body.velocity.x) >= playerSpeed*2){
            player.body.velocity.x = playerSpeed*2*(player.body.velocity.x/Math.abs(player.body.velocity.x));
        }
        if(Math.abs(player.body.velocity.y) >= playerSpeed*2){
            player.body.velocity.y = playerSpeed*2*(player.body.velocity.y/Math.abs(player.body.velocity.y));
        }
        player.body.allowGravity = false;
        player.body.bounce.set(0.8)


        if(controls.right.isDown){
        //  player.animations.play('runRight');
            player.body.velocity.x -= playerSpeed;
        }

        if(controls.left.isDown){
        //  player.animations.play('runLeft');
            player.body.velocity.x += playerSpeed;
        }

        if(controls.up.isDown){
            player.body.velocity.y -= playerSpeed;
        }

        if(controls.down.isDown){
            player.body.velocity.y += playerSpeed;
        }

        if(game.input.activePointer.isDown){
            shootbullet(game);
        }

        //State checks
        if(remaining==0){
            this.game.state.start('Level2');
        }

        //Enemy movement
        //radians1 = game.physics.arcade.angleBetweenCenters(enemy1, player);
        //game.physics.arcade.velocityFromRotation(radians1, 200, enemy1.body.velocity);
        /*distance1_from_player = Math.sqrt(Math.abs((player.x - enemy1.x))+Math.abs((player.y - enemy1.y)));
        if(distance1_from_player<=18){
            enemyMovement(enemy1);
            enemy1.seen = 1;
        } else if(enemy1.seen==1){
            enemyMovement(enemy1);
        } else {
            enemy1.body.velocity.x = 0;
            enemy1.body.velocity.y = 0;
        }

        distance2_from_player = Math.sqrt(Math.abs((player.x - enemy1.x))+Math.abs((player.y - enemy1.y)));
        if(distance2_from_player<=18){
            enemyMovement(enemy1);
            enemy2.seen = 1;
        } else if(enemy2.seen==1){
            enemyMovement(enemy1);
        } else {
            enemy1.body.velocity.x = 0;
            enemy1.body.velocity.y = 0;
        }*/
        enemyTargetted(enemy1);
        enemyTargetted(enemy2);
        enemyTargetted(enemy3);
        enemyTargetted(enemy4);
        enemyTargetted(enemy5);
        enemyTargetted(enemy6);
        enemyTargetted(enemy7);
        enemyTargetted(enemy8);
        enemyTargetted(enemy9);
        enemyTargetted(enemy10);
        /*
        this.barProgress = enemy1.hp;
        this.enemyBar1.context.clearRect(0, 0, this.enemyBar1.width, this.enemyBar1.height);
        this.enemyBar1.context.fillStyle = '#f00';
        this.enemyBar1.context.fillRect(0, 0, enemy1.hp*8, 8);
        this.enemyBar1.dirty = true;
        */
        if(Math.abs(this.camera.x + 800 - player.x)<400){
            this.camera.x += 2000/Math.abs(this.camera.x + 800 - player.x);
        }

        if(Math.abs(this.camera.x - player.x)<400){
            this.camera.x -= 2000/Math.abs(this.camera.x - player.x);
        }

        if(Math.abs(this.camera.y + 600 - player.y)<400){
            this.camera.y += 2000/Math.abs(this.camera.y + 600 - player.y);
        }

        if(Math.abs(this.camera.y - player.y)<400){
            this.camera.y -= 2000/Math.abs(this.camera.y - player.y);
        }
    },

    resetPlayer: function(game){
        game.state.start('FailState'); 
    }
}; 


//LEVEL 2 BELOW

Game.Level2 = function(){};

Game.Level2.prototype = {
    create: function(){
        this.stage.backgroundColor = "#000";
        winText = this.game.add.text(312, 100, 'Nicely done!!',
                                        {  fontSize: '32px',
                                           fill: '#fff'});
        again_button = this.add.button(305, 500, 'buttons',
                                        function(){
                                            this.game.state.start('Level1');
                                        },this,2,1,0);
    }
}

//FAIL STATE BELOW


Game.FailState = function(){};

Game.FailState.prototype = {

    create: function(){
        this.stage.backgroundColor = "#000";
        failText = this.game.add.text(325, 100, 'You failed!', 
                                        { fontSize: '32px',
                                          fill: '#fff'});
        retry_button = this.add.button(305, 500, 'buttons',
                                        function(){
                                            this.game.state.start('Level1');
                                        },this,2,1,0);
    }
}

function checkOverlap(spriteA,spriteB){

    var boundsA = spriteA.getBounds();
    var boundsB = spriteB.getBounds();
    return Phaser.Rectangle.intersects(boundsA,boundsB);
}


function shootbullet(game) {
    if(game.time.now > shootTime/* && bullets.countDead() > 0*/) {
        shootTime = game.time.now + 200;
        var bullet = bullets.getFirstDead();
        bullet.reset(player.x, player.y);
        game.physics.arcade.moveToPointer(bullet, 2000);
        bullet.body.allowGravity = false;
        bullet.body.bounce.set(0.2);
        game.add.audio('shoot').play();
    }
}

function enemyMovement(enemy){

    if(Math.abs(enemy.x - player.x) <= 2){
        enemy.x = player.x;
    } else if(enemy.x > player.x){
        enemy.body.velocity.x -= enemySpeed;
    } else if(enemy.x < player.x) {
        enemy.body.velocity.x += enemySpeed;
    } else if(enemy.x == player.x) {
        enemy.body.velocity.x = 0;
    }

    if(Math.abs(enemy.body.velocity.x) > enemySpeed){
        enemy.body.velocity.x = enemySpeed*(enemy.body.velocity.x/Math.abs(enemy.body.velocity.x));
    }

    if(Math.abs(enemy.y - player.y) <= 2){
        enemy.y = player.y;
    } else if(enemy.y > player.y){
        enemy.body.velocity.y -= enemySpeed;
    } else if(enemy.y < player.y) {
        enemy.body.velocity.y += enemySpeed;
    } else if(enemy.y == player.y) {
        enemy.body.velocity.y = 0;
    }

    if(Math.abs(enemy.body.velocity.y) > enemySpeed){
        enemy.body.velocity.y = enemySpeed*(enemy.body.velocity.y/Math.abs(enemy.body.velocity.y));
    }
}

function enemyTargetted(enemy){
    enemy.distance_from_player = Math.sqrt(Math.abs((player.x - enemy.x))+Math.abs((player.y - enemy.y)));
    if(enemy.distance_from_player<=18){
        enemyMovement(enemy);
        enemy.seen = 1;
    } else if(enemy.seen==1){
        enemyMovement(enemy);
    } else {
        enemy.body.velocity.x = 0;
        enemy.body.velocity.y = 0;
    }
}




    </script>
</body>
</html>